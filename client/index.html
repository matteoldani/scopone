<!DOCTYPE html>
<html>
  <head>
    <script src="/client/js/poker.min.js"></script>
  </head>
  <body>
    <input type="text" id="nickname" placeholder="nickname">
    <button id="emitNickname" > INVIA </button>

    <button id="createTable" hidden> CREA TAVOLO </button>
    <button id="joinTable" hidden> PARTECIPA TAVOLO </button>

    <input type="text" placeholder="numero tavolo" id="tableN" hidden>

    <button id="emitNum" hidden> INVIA </button>

    <h3 id="wait" hidden> ATTENDI CHE IL TAVOLO SIA COMPLETO </h3>

    <div id="cont" hidddn>

      <input type="text" value="" hidden id="numT">
      <input type="text" value="" hidden id="p1">
      <input type="text" value="" hidden id="p2">
      <input type="text" value="" hidden id="p3">
      <input type="text" value="" hidden id="p4">

    </div>

    <div id="campo" style="min-height: 150px; background: green;">

    </div>

    <div id="mano" style="float: left;">

    </div>
    <br>
    <div style="width: 100%";>

      <p id="text" hidden> Ultima carta giocata da <span id="whoPlayed"><span> </p>
      <div id="ultimaCarta">
        <div id="carta"></div>
      </div>

    </div>


    <script src="/socket.io/socket.io.js"></script>

    <script>
      var socket = io();

      var nickname = document.getElementById('nickname');
      var emitNickname = document.getElementById('emitNickname');

      var createTable = document.getElementById('createTable');
      var joinTable = document.getElementById('joinTable');

      var tableN = document.getElementById('tableN');
      var emitNum = document.getElementById('emitNum');


      var wait = document.getElementById('wait');

      var cont = document.getElementById('cont');
      var numT = document.getElementById('numT');
      var p1 = document.getElementById('p1');
      var p2 = document.getElementById('p2');
      var p3 = document.getElementById('p3');
      var p4 = document.getElementById('p4');

      var text = document.getElementById('text');
      var nomeUltimo = document.getElementById('whoPlayed');
      var lastPlayedCard = document.getElementById("ultimaCarta");


      var click = 0;


      var Carta = function(seme, valore){

        var self = {
          seme:seme,
          valore:valore,
        }

        return self
      }

      var makeCartaFromId = function(id){
        var data = id.split("-");
        var carta = Carta(data[1], data[0]);
        console.log("ho creato la carta dall'id: ", carta);
        return carta;
      }

      var mano;
      var campo;

      var ultimaCartaGiocata;
      var nomeGiocatoreInTurno;

      var conteggioGiocta = 10; //numero di carte ancora giocabili

      /*socker.on('aggiornaCarta', function(data){
        nomeUltimo.innerText = data.nickname;
        var div = creaCarta(ultimaCartaGiocata);
        div.id = "carta";
        lastPlayedCar.getElementById("carta").remove();
        lastPlayedCar.appendChild(div);
      });*/

      emitNickname.onclick = function(){
        //emetto un messaggio
        socket.emit('nickname', {
          nickname:nickname.value
        });
        //nascondo il vecchio e mostro il nuovo
        nickname.hidden = true;
        emitNickname.hidden = true;
        createTable.hidden = false;
        joinTable.hidden = false;
      }

      createTable.onclick = function(){
        createTable.hidden = true;
        joinTable.hidden = true;
        console.log("here at creazione in html");
        socket.emit('creazione',{
          nome:'tavolo'
        });
      }

      joinTable.onclick = function(){
        console.log("here at join in html");
        createTable.hidden = true;
        joinTable.hidden = true;
        tableN.hidden = false;
        emitNum.hidden = false;
      }

      emitNum.onclick = function(){
        var numero = tableN.value;

        socket.emit('join', {
          num:numero,
        });

        tableN.hidden = true;
        emitNum.hidden = true;
        wait.hidden = false;
        text.hidden = false;
      }

      socket.on('tableNum', function(data){
        console.log(data.num);
        cont.hidden = false;
        numT.hidden = false;
        numT.value = data.num;
        numT.readOnly = true;
        wait.hidden = false;
        text.hidden = false;
      });

      //momentaneamnte non usata, non dico chi sono i partecianti in quanto gia visto che funziona
      socket.on('partecipanti', function(data){
        if(cont.hidden == true){
          cont.hidden = false;
        }
        if(numT.hidden == true){
          numT.hidden = false;
        }

        wait.hidden = true;



        p1.hidden = false;
        p2.hidden = false;
        p3.hidden = false;
        p4.hidden = false;

        numT.value = data.num;

        p1.readOnly = true;
        p2.readOnly = true;
        p3.readOnly = true;
        p4.readOnly = true;
        numT.readOnly = true;

        p1.value = data.player1;
        p2.value = data.player2;
        p3.value = data.player3;
        p4.value = data.player4;



      });

      socket.on('avanti', function(){
        var data = {
          caso: 0,
          data: 0
        }

        socket.emit('procedi', data);

      });

      socket.on('sommeMultiple', function(campo){

        //variabile di prova per vedere se posso usarla dentro la funzione
        var valSomma = 0;
        var cartePrese = [];

        console.log('sono state trovate più somme');
        alert("ci sono più somme possibili, selezione le carte da prendere dal campo");
        console.log(campo.length);

        //rendo cliccabili elementi del campo
        for(var i in campo){
          let id = campo[i].valore.toString().concat("-");
          id = id.concat(campo[i].seme);
          document.getElementById(id).onclick = function(){
            //semplicemente cerco di capire se riesco a selezionare la carta giusta
            console.log("carta selezionata: ", id);
            let c = makeCartaFromId(id);
            console.log("la carta giocata dal giocatore era: ", ultimaCartaGiocata);
            valSomma += parseInt(id.slice(0,1));
            console.log(valSomma);
            cartePrese.push(c);

            if(valSomma == ultimaCartaGiocata){
              var pack = {
                data:cartePrese,
              }
              socket.emit('procedi', pack);
              console.log(cartePrese);
              cartePrese.splice(0, cartePrese.length);
            }else{
              if(valSomma > ultimaCartaGiocata){
                alert('hai sbagliato la selezione');
                cartePrese.splice(0, cartePrese.length);
                socket.emit('reSommeMultiple');
              }
            }
          }
        }

      });

      //data una carta creo il div corrispondente
      var creaCarta = function(carta){
        var div = document.createElement("div");
        div.style.width = "65px";
        div.style.height = "100px";
        div.style.margin = "10px";

        div.style.backgroundImage = "url('client/image/PNG/"+carta.valore.toString()+carta.seme+".png'";
        div.style.border = "solid #000000";
        var id = carta.valore.toString().concat("-");
        id = id.concat(carta.seme);
        div.id = id;

        div.style.backgroundSize = "contain";
        div.style.float = "left";
        console.log(id);
        return div;
      }

      socket.on('mano', function(data){
        console.log('ho ricevuto la mano')

        mano = data; //salvo la mano

        //stampo la mano

        for(i in mano){
          var div = creaCarta(mano[i]);
          document.getElementById("mano").appendChild(div);
          //console.log("drawing", mano[i].seme, mano[i].valore.toString(), i);
        }
      });

      socket.on('play', function(c, s){
        wait.innerText = "GIOCA, TOCCA A TE";
        click = 1;

        for(let i = 0; i<conteggioGiocta;i++){
          let id = mano[i].valore.toString().concat("-");
          id = id.concat(mano[i].seme);
          document.getElementById(id).onclick = function(){
            if(click == 1){
              let idf = id;
              //tolgo carta tra la il div mano
              //devo anche toglierla dalla mano prima di andare avanti
              document.getElementById(idf).remove();

              //cerco indice della carta
              //separo id per ottenere valore e seme
              data = idf.split("-");
              ultimaCartaGiocata = data[0];

              var indice;
              for(var k in mano){
                if(parseInt(data[0]) == mano[k].valore && data[1] == mano[k].seme){
                  indice = k;
                }
              }

              socket.emit('card', {
                valore:mano[indice].valore,
                seme:mano[indice].seme,
              });
              mano.splice(indice,1);
              conteggioGiocta--;
            }

          };

        }

      });

      socket.on('try', function(){
        alert("try");
      })

      //disegno uil campo, dovrebbe essere richiamata ogni colta che un giocatore fa una mossa


      socket.on('drawCampo', function(campo){

        let i;
        for(i in campo){
          let div = creaCarta(campo[i]);
          if(document.getElementById(div.id) == null){
            document.getElementById("campo").appendChild(div);
          }
        }

      });

      //tolgo dal campo le carte che vengono prese
      socket.on('removeCardFromCampo', function(carte){
        console.log("sto per rimuovere le carte dal campo ");
        for(i in carte){
          var id = carte[i].valore.toString().concat("-");
          id = id.concat(carte[i].seme);
          if(document.getElementById(id) != null){
            document.getElementById(id).remove();
            console.log("ho eliminato la carta con id", id);
          }

        }
      });


      socket.on('stop', function(){
          wait.innerText = "ATTENDI, NON È IL TUO TURNO";
          click = 0;
      });

      socket.on('prese', function(data){
        for(i in data){
          var div = creaCarta(data[i]);
          document.getElementById("mano").appendChild(div);
        }
      });

      socket.on('punti', function(data){
        if(data.p > data.pA){
          alert('HAI VINTO: ', data.p, ' punti');
        }else{
          if(data.pA>data.p){
              alert('HAI PERSO: ', data.p, ' punti');
          }else{
            alert('PAREGGIO: ', data.p, ' punti');
          }
        }
      });

      socket.on('somma',  function(data){
          console.log('selezione della somma');
          for(i in data){
            console.log("somma: ", data[i]);
          }
      });

      socket.on("aggiornaCarta", function(data){
        console.log("qualcosa sta succedentro?0");
        var div = creaCarta(data);
        div.id = "carta";
        document.getElementById("carta").remove();
        lastPlayedCard.appendChild(div);

      })

      //js library

    </script>

  </body>
</html>
